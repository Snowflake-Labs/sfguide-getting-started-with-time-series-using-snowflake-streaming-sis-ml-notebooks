-- Set role, context, and warehouse
USE ROLE ROLE_HOL_TIMESERIES;
USE HOL_TIMESERIES.TRANSFORM;
USE WAREHOUSE HOL_TRANSFORM_WH;

-- Setup Transform Dynamic Tables
-- Sensor metadata (Dimension)
CREATE OR REPLACE DYNAMIC TABLE HOL_TIMESERIES.TRANSFORM.DT_TS_TAG_METADATA
TARGET_LAG = '1 MINUTE'
WAREHOUSE = HOL_TRANSFORM_WH
REFRESH_MODE = 'INCREMENTAL'
AS
SELECT
    ROW_NUMBER() OVER (PARTITION BY NULL ORDER BY NULL) AS TAGKEY,
    SRC.NAMESPACE,
    SRC.TAGNAME,
    TO_ARRAY(SRC.TAGNAME) AS TAGALIAS,
    SRC.TAGDESCRIPTION,
    SRC.TAGUNITS,
    SRC.TAGDATATYPE
FROM (
    SELECT DISTINCT
        SRC.RECORD_METADATA:headers:namespace::VARCHAR AS NAMESPACE,
        UPPER(CONCAT('/', SRC.RECORD_METADATA:headers:namespace::VARCHAR, '/', TRIM(SRC.RECORD_CONTENT:tagname::VARCHAR))) AS TAGNAME,
        SRC.RECORD_METADATA:headers:source::VARCHAR AS TAGDESCRIPTION,
        SRC.RECORD_CONTENT:units::VARCHAR AS TAGUNITS,
        SRC.RECORD_CONTENT:datatype::VARCHAR AS TAGDATATYPE
    FROM HOL_TIMESERIES.STAGING.RAW_TS_IOTSTREAM_DATA SRC
    QUALIFY ROW_NUMBER() OVER (PARTITION BY UPPER(CONCAT('/', SRC.RECORD_METADATA:headers:namespace::VARCHAR, '/', TRIM(SRC.RECORD_CONTENT:tagname::VARCHAR))) ORDER BY SRC.RECORD_CONTENT:timestamp::NUMBER) = 1
) SRC;

-- Sensor readings (Fact)
CREATE OR REPLACE DYNAMIC TABLE HOL_TIMESERIES.TRANSFORM.DT_TS_TAG_READINGS
TARGET_LAG = '1 MINUTE'
WAREHOUSE = HOL_TRANSFORM_WH
REFRESH_MODE = 'INCREMENTAL'
AS
SELECT
    META.TAGKEY,
    SRC.RECORD_CONTENT:timestamp::VARCHAR::TIMESTAMP_NTZ AS TS,
    SRC.RECORD_CONTENT:value::VARCHAR AS VAL,
    TRY_CAST(SRC.RECORD_CONTENT:value::VARCHAR AS FLOAT) AS VAL_NUMERIC,
    SRC.RECORD_METADATA:partition::VARCHAR AS PARTITION,
    SRC.RECORD_METADATA:offset::VARCHAR AS OFFSET
FROM HOL_TIMESERIES.STAGING.RAW_TS_IOTSTREAM_DATA SRC
INNER JOIN HOL_TIMESERIES.TRANSFORM.DT_TS_TAG_METADATA META ON META.TAGNAME = UPPER(CONCAT('/', SRC.RECORD_METADATA:headers:namespace::VARCHAR, '/', TRIM(SRC.RECORD_CONTENT:tagname::VARCHAR)))
QUALIFY ROW_NUMBER() OVER (PARTITION BY META.TAGKEY, SRC.RECORD_CONTENT:timestamp::VARCHAR::TIMESTAMP_NTZ ORDER BY SRC.RECORD_METADATA:offset::VARCHAR DESC) = 1;
