-- Set role, context, and warehouse
USE ROLE ROLE_HOL_TIMESERIES;
USE SCHEMA HOL_TIMESERIES.STAGING;
USE WAREHOUSE HOL_TRANSFORM_WH;

-- Setup staging tables
-- IOTSTREAM
CREATE OR REPLACE TABLE HOL_TIMESERIES.STAGING.RAW_TS_IOTSTREAM_DATA (
    RECORD_METADATA VARIANT,
    RECORD_CONTENT VARIANT
)
CHANGE_TRACKING = TRUE
COMMENT = 'IOTSTREAM staging table.'
;

-- Setup stream change tracking
CREATE OR REPLACE STREAM HOL_TIMESERIES.STAGING.STREAM_RAW_TS_IOTSTREAM_DATA
ON TABLE HOL_TIMESERIES.STAGING.RAW_TS_IOTSTREAM_DATA
APPEND_ONLY = TRUE
SHOW_INITIAL_ROWS = TRUE
COMMENT = 'Append only table stream for IOTSTREAM staging table.'
;

/* EXTERNAL ACTIVITY

Configure the IOT Stream client

*/

-- Show stream channels connections
SHOW CHANNELS;

-- Check stream table data
SELECT * FROM HOL_TIMESERIES.STAGING.RAW_TS_IOTSTREAM_DATA LIMIT 10;